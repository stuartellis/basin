image: docker:20.10.20

services:
  - name: docker:20.10.20-dind

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  ST_ENABLE_BACKEND: "false"
  ST_RUNNER_VERSION: ci
  STACK_NAME: infra_canary
  STACK_TOOLS_RUNNER_IMAGE: stacktools-runner:ci

stages:
  - build_tools_image
  - check_terraform

build_tools_image:
  stage: build_tools_image
  script:
    - apk add make
    - make stackrunner-build

check_terraform:
  stage: check_terraform
  script:
    - make stack-check-fmt
    - make stack-init
    - make stack-validate
